{
  "name": "Send Itinerary PDF via Gmail",
  "nodes": [
    {
      "parameters": {
        "path": "send-itinerary",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "functionCode": "const itinerary = $json.itinerary;\nconst constraints = $json.constraints;\nconst sources = $json.sources || {};\nconst weather = $json.weather || {};\n\nconst city = constraints?.resolvedCity || constraints?.city || 'Unknown City';\nconst numDays = constraints?.numDays || 0;\nconst pace = constraints?.pace || 'normal';\nconst interests = (constraints?.interests || []).join(', ') || 'Various';\nconst maxDailyHours = constraints?.maxDailyHours || 8;\n\nlet daysHtml = '';\nif (itinerary?.days && Array.isArray(itinerary.days)) {\n  itinerary.days.forEach((day, dayIdx) => {\n    daysHtml += `<div style=\"margin: 30px 0; page-break-inside: avoid;\">`;\n    daysHtml += `<h2 style=\"color: #1e40af; border-bottom: 2px solid #1e40af; padding-bottom: 10px;\">Day ${dayIdx + 1}</h2>`;\n    \n    if (day.blocks && Array.isArray(day.blocks)) {\n      day.blocks.forEach(block => {\n        daysHtml += `<div style=\"margin: 15px 0; padding: 15px; background: #f0f9ff; border-left: 4px solid #0284c7; border-radius: 4px;\">`;\n        daysHtml += `<h3 style=\"margin: 0 0 10px 0; color: #0284c7; text-transform: capitalize;\">${block.timeOfDay}</h3>`;\n        \n        if (block.poi) {\n          daysHtml += `<p style=\"margin: 5px 0; font-weight: bold;\">${block.poi.name}</p>`;\n          daysHtml += `<p style=\"margin: 3px 0; font-size: 0.9em; color: #666;\">Duration: ${block.poi.duration || 'N/A'}</p>`;\n          if (block.travelTime) {\n            daysHtml += `<p style=\"margin: 3px 0; font-size: 0.9em; color: #666;\">ðŸš— ~${block.travelTime.minutes || 0} min travel time</p>`;\n          }\n          if (block.poi.notes) {\n            daysHtml += `<p style=\"margin: 5px 0; font-size: 0.9em;\">${block.poi.notes}</p>`;\n          }\n        }\n        \n        if (block.notes && Array.isArray(block.notes) && block.notes.length > 0) {\n          daysHtml += `<ul style=\"margin: 5px 0; padding-left: 20px;\">`;\n          block.notes.forEach(note => {\n            daysHtml += `<li style=\"font-size: 0.9em;\">${note}</li>`;\n          });\n          daysHtml += `</ul>`;\n        }\n        \n        daysHtml += `</div>`;\n      });\n    }\n    daysHtml += `</div>`;\n  });\n}\n\nlet sourcesHtml = '';\nif (sources && Object.keys(sources).length > 0) {\n  sourcesHtml = `<div style=\"margin-top: 40px; page-break-inside: avoid;\">`;\n  sourcesHtml += `<h2 style=\"color: #1e40af; border-bottom: 2px solid #1e40af; padding-bottom: 10px;\">Sources</h2>`;\n  sourcesHtml += `<ul style=\"padding-left: 20px;\">`;\n  \n  Object.values(sources).forEach(source => {\n    if (source.name) {\n      sourcesHtml += `<li>${source.name}`;\n      if (source.sourceType) {\n        sourcesHtml += ` (${source.sourceType})`;\n      }\n      sourcesHtml += `</li>`;\n    }\n  });\n  \n  sourcesHtml += `</ul></div>`;\n}\n\nconst now = new Date().toLocaleString();\n\nconst html = `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${city} - ${numDays} Day Itinerary</title>\n  <style>\n    body {\n      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n      line-height: 1.6;\n      color: #333;\n      max-width: 850px;\n      margin: 0 auto;\n      padding: 20px;\n      background: white;\n    }\n    h1 {\n      color: #0f172a;\n      border-bottom: 3px solid #1e40af;\n      padding-bottom: 15px;\n      margin-bottom: 10px;\n    }\n    .summary {\n      background: #f0f9ff;\n      padding: 15px;\n      border-radius: 6px;\n      margin-bottom: 30px;\n      border-left: 4px solid #0284c7;\n    }\n    .summary-item {\n      margin: 5px 0;\n      font-size: 0.95em;\n    }\n    .footer {\n      margin-top: 50px;\n      padding-top: 20px;\n      border-top: 1px solid #ddd;\n      font-size: 0.85em;\n      color: #666;\n    }\n  </style>\n</head>\n<body>\n  <h1>${city} â€” ${numDays}-Day Itinerary</h1>\n  \n  <div class=\"summary\">\n    <div class=\"summary-item\"><strong>Pace:</strong> ${pace.charAt(0).toUpperCase() + pace.slice(1)}</div>\n    <div class=\"summary-item\"><strong>Interests:</strong> ${interests}</div>\n    <div class=\"summary-item\"><strong>Max Daily Hours:</strong> ${maxDailyHours} hours</div>\n  </div>\n  \n  ${daysHtml}\n  \n  ${sourcesHtml}\n  \n  <div class=\"footer\">\n    <p>Generated on: ${now}</p>\n    <p>Session ID: ${$json.sessionId}</p>\n    <p><em>This itinerary was generated by Travel Planner.</em></p>\n  </div>\n</body>\n</html>`;\n\nreturn { html };"
      },
      "id": "build-html",
      "name": "Build HTML",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [440, 300]
    },
    {
      "parameters": {
        "url": "https://api.pdfshift.io/v3/convert/html",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "bodyParametersUiType": "json",
        "body": "{\n  \"source\": \"{{ $json.html }}\",\n  \"landscape\": false,\n  \"margin\": \"10mm\"\n}",
        "options": {}
      },
      "id": "pdf-generator",
      "name": "PDF Generator (PDFShift)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [640, 300],
      "credentials": {
        "httpBasicAuth": "pdfshift_credential"
      }
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "send",
        "toEmail": "{{ $json.toEmail }}",
        "subject": "{{ $json.subject || 'Your Trip Itinerary' }}",
        "bodyType": "text",
        "textBody": "Attached is your itinerary PDF.",
        "attachments": {
          "attachmentsBinary": [
            {
              "property": "pdf",
              "fileProperties": {
                "fileName": "itinerary.pdf"
              }
            }
          ]
        }
      },
      "id": "gmail-send",
      "name": "Gmail Send",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [840, 300],
      "credentials": {
        "gmailOAuth2": "gmail_oauth"
      }
    },
    {
      "parameters": {
        "respondWithOptions": {
          "responseType": "json",
          "responseData": "{\n  \"ok\": true,\n  \"messageId\": \"{{ $json.id }}\",\n  \"sentTo\": \"{{ $input.first().json.toEmail }}\"\n}"
        }
      },
      "id": "respond-success",
      "name": "Respond to Webhook (Success)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1040, 200]
    },
    {
      "parameters": {
        "respondWithOptions": {
          "responseType": "json",
          "responseData": "{\n  \"ok\": false,\n  \"error\": \"{{ $json.errorMessage || 'Failed to send email' }}\"\n}"
        }
      },
      "id": "respond-error",
      "name": "Respond to Webhook (Error)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1040, 400]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [
        [
          {
            "node": "build-html",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "build-html": {
      "main": [
        [
          {
            "node": "pdf-generator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pdf-generator": {
      "main": [
        [
          {
            "node": "gmail-send",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "respond-error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "gmail-send": {
      "main": [
        [
          {
            "node": "respond-success",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "respond-error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
